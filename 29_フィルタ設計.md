以下のように、周波数領域の伝達関数から時刻領域の２次常微分方程式を導きます。

---

## 1. 伝達関数の定義

2次バターワース・ローパスフィルタの伝達関数を

$$
H(s)=\frac{Y(s)}{X(s)}
=\frac{\omega_0^2}{s^2 + \sqrt2\,\omega_0\,s + \omega_0^2}
$$

とします。ここで

* $X(s)$ は入力 $x(t)$ のラプラス変換
* $Y(s)$ は出力 $y(t)$ のラプラス変換
* $\omega_0$ はカットオフ角周波数

---

## 2. 両辺を分母で掛け合わせ

$$
Y(s)
= H(s)\,X(s)
\;\Longrightarrow\;
\bigl(s^2 + \sqrt2\,\omega_0\,s + \omega_0^2\bigr)\,Y(s)
= \omega_0^2\,X(s).
$$

---

## 3. ラプラス演算子 $s$ と時域微分の対応

ラプラス変換の性質より、

$$
\mathcal{L}\{y'(t)\}=s\,Y(s)-y(0^-),\quad
\mathcal{L}\{y''(t)\}=s^2\,Y(s)-s\,y(0^-)-y'(0^-).
$$

ここでは初期条件 $y(0^-)=y'(0^-)=0$ と仮定して簡単化すると、

$$
\mathcal{L}\{y'(t)\}\approx s\,Y(s),\quad
\mathcal{L}\{y''(t)\}\approx s^2\,Y(s).
$$

---

## 4. 逆ラプラス変換して時刻領域方程式に

$$
\bigl(s^2 + \sqrt2\,\omega_0\,s + \omega_0^2\bigr)\,Y(s)
= \omega_0^2\,X(s)
$$

を逆ラプラス変換すると、

$$
\mathcal{L}^{-1}\{s^2Y(s)\}
\;+\;\sqrt2\,\omega_0\,\mathcal{L}^{-1}\{sY(s)\}
\;+\;\omega_0^2\,\mathcal{L}^{-1}\{Y(s)\}
\;=\;\omega_0^2\,\mathcal{L}^{-1}\{X(s)\}.
$$

すなわち

$$
y''(t)
\;+\;\sqrt2\,\omega_0\,y'(t)
\;+\;\omega_0^2\,y(t)
\;=\;\omega_0^2\,x(t).
$$

これが求める**２次常微分方程式**です。

---

### 最終形

$$
\boxed{
y''(t)
\;+\;\sqrt2\,\omega_0\,y'(t)
\;+\;\omega_0^2\,y(t)
\;=\;\omega_0^2\,x(t)
}
$$

* 左辺は「フィルタ出力の２階＋１階＋０階微分の線形結合」
* 右辺は「カットオフ周波数の２乗かける入力」

これにより、伝達関数 $H(s)$ と同等の時刻領域モデルが得られました。



以下、アナログの２次バターワースローパスフィルタの微分方程式から始めて、**有限差分を用いた完全手計算**で、最終的に

```math
y[n]
= y[n-1]
\;+\;
\frac{(\omega_c\Delta t)^2}{D}
\,\bigl(x[n]-y[n-1]\bigr)
\;+\;
\frac{1}{D}
\,\bigl(y[n-1]-y[n-2]\bigr)
\quad\bigl(D=1+\sqrt2\,\omega_c\Delta t+(\omega_c\Delta t)^2\bigr)
```

という「増分形式（インクリメンタルフォーム）」を得るまでを、飛ばさずに解説します。

---

## 1. アナログ微分方程式を書き下す

2次バターワースローパスは次の２次常微分方程式で表されます（入力を $x(t)$、出力を $y(t)$）：

```math
\underbrace{\frac{d^2y}{dt^2}}_{\displaystyle y''}
;+\;\sqrt2\,\omega_c\,\underbrace{\frac{dy}{dt}}_{\displaystyle y'}
;+\;\omega_c^2\,y
;=\;\omega_c^2\,x
```

* $\omega_c$：カットオフ角周波数 \[rad/s]
* $\sqrt2$：2次バターワース特有の係数

---

## 2. 時間離散化：差分近似

サンプリング周期を $\Delta t$ とし、$t=n\Delta t$ における信号を

$$
y[n] = y(n\Delta t),\quad x[n] = x(n\Delta t)
$$

で表すと、微分を以下の「後退差分」で近似できます：

$$
\begin{aligned}
y'(n\Delta t)
&\approx \frac{y[n] - y[n-1]}{\Delta t},\\
y''(n\Delta t)
&\approx \frac{\,y[n] - 2\,y[n-1] + y[n-2]\,}{\Delta t^2}.
\end{aligned}
$$

---

## 3. １．の式に差分を代入

(1) の両辺にこれを代入：

$$
\frac{y[n]-2y[n-1]+y[n-2]}{\Delta t^2}
\;+\;\sqrt2\,\omega_c\;\frac{y[n]-y[n-1]}{\Delta t}
\;+\;\omega_c^2\,y[n]
\;=\;\omega_c^2\,x[n].
$$

---

## 4. $\Delta t^2$ を掛けて整理

分母を消すために $\Delta t^2$ を両辺に掛けると、

$$
y[n] - 2y[n-1] + y[n-2]
\;+\;\sqrt2\,\omega_c\,\Delta t\,(y[n]-y[n-1])
\;+\;(\omega_c\Delta t)^2\,y[n]
\;=\;(\omega_c\Delta t)^2\,x[n].
$$

---

## 5. 同じ $y[n]$, $y[n-1]$, $y[n-2]$ 項ごとにまとめる

左辺を $y[n]$、$y[n-1]$、$y[n-2]$ の係数で整理します。まずそれぞれの項を展開：

* **$y[n]$ の係数**

```math
1 
\;+\;\sqrt2\,\omega_c\Delta t
\;+\;(\omega_c\Delta t)^2
\;=\;D,
\quad D \coloneqq 1 + \sqrt2\,c + c^2,\quad c\coloneqq\omega_c\Delta t.
```
  
* **$y[n-1]$ の係数**

```math
-2 
\;-\;\sqrt2\,\omega_c\Delta t
\;=\;
-\bigl(2 + \sqrt2\,c\bigr).
```

* **$y[n-2]$ の係数**

```math
+1.
```

右辺は $(\omega_c\Delta t)^2\,x[n]=c^2\,x[n]$。
従って等式は

$$
D\,y[n]
\;-\;(2+\sqrt2\,c)\,y[n-1]
\;+\;1\cdot y[n-2]
\;=\;c^2\,x[n].
$$

---

## 6. $y[n]$ について解く

両辺を $D$ で割って、直接形（ノーマライズ版）にします：

```math
y[n]
= \underbrace{\frac{2+\sqrt2\,c}{D}}_{p_1}\,y[n-1]
\;-\;\underbrace{\frac{1}{D}}_{p_2}\,y[n-2]
\;+\;\underbrace{\frac{c^2}{D}}_{p_3}\,x[n].
```

ここで

```math
\begin{aligned}
p_1 &= \frac{2+\sqrt2\,c}{\,1+\sqrt2\,c+c^2\,},\\
p_2 &= \frac{1}{\,1+\sqrt2\,c+c^2\,},\\
p_3 &= \frac{c^2}{\,1+\sqrt2\,c+c^2\,}.
\end{aligned}
```

式(2) は「2次 IIR フィルタの直接形」です。

---

## 7. 増分（インクリメンタル）形式への書き換え

式(2) から、1 サンプル前との差分を使って書くと、制御実装や組み込みで便利な形になります。

```math
\begin{aligned}
y[n] - y[n-1]
&= \underbrace{p_3}_{\frac{c^2}{D}}\,x[n]
  + \underbrace{p_1}_{\frac{2+\sqrt2 c}{D}}\,y[n-1]
  - \underbrace{p_2}_{\frac{1}{D}}\,y[n-2]
  - y[n-1]\\
&= \frac{c^2}{D}\,x[n]
  + \Bigl(\frac{2+\sqrt2\,c}{D}-1\Bigr)\,y[n-1]
  - \frac{1}{D}\,y[n-2].
\end{aligned}
```

ただし

```math
\frac{2+\sqrt2\,c}{D}-1
= \frac{2+\sqrt2\,c - (1+\sqrt2\,c+c^2)}{D}
= \frac{1 - c^2}{D}.
```

したがって

```math
\begin{aligned}
y[n] - y[n-1]
&= \frac{c^2}{D}\,x[n]
  + \frac{1 - c^2}{D}\,y[n-1]
  - \frac{1}{D}\,y[n-2]\\
&= \underbrace{\frac{c^2}{D}}_{\alpha}\,
    \bigl(x[n]-y[n-1]\bigr)
  + \underbrace{\frac{1}{D}}_{\beta}\,
    \bigl(y[n-1]-y[n-2]\bigr).
\end{aligned}
```

最後に両辺に $y[n-1]$ を足し戻すと、**増分形式** が得られます：

```math
\boxed{
y[n]
= y[n-1]
+ \alpha\,\bigl(x[n]-y[n-1]\bigr)
+ \beta\,\bigl(y[n-1]-y[n-2]\bigr),
}
```

```math
\text{where}\quad
c = \omega_c\Delta t,\quad
D = 1 + \sqrt2\,c + c^2,
\quad
\alpha = \frac{c^2}{D},\quad
\beta = \frac{1}{D}.
```

---

### まとめ

1. **アナログ微分方程式**
   $\;y'' + \sqrt2\,\omega_c\,y' + \omega_c^2 y = \omega_c^2 x\;$ をスタート。
2. **差分近似**
   $\;y' \approx (y[n]-y[n-1])/\Delta t,\; y''\approx(y[n]-2y[n-1]+y[n-2])/\Delta t^2\;$。
3. **整理～正規化**
   項をまとめて $y[n]$ について解き、係数を $D,\,p_1,p_2,p_3$ に整理。
4. **増分形式**
   差分 $y[n]-y[n-1]$ を使うことで、組み込み実装に向く形に書き換え。

これで、**「2次バターワースローパス」を離散時間で動かすための差分方程式**が完全に理解できるはずです。



以下、

1. 連続時間の伝達関数から１次バターワースローパスの１次常微分方程式を導く手順、
2. その微分方程式を「後退差分（Backward‐Euler）」で離散化して差分方程式に落とし込む手順
   を、すべての計算過程を省略せずに示します。

---

## 1. 伝達関数から１次常微分方程式の導出

**ステップ1**：１次バターワースローパスの伝達関数を定義します。
カットオフ角周波数を $\omega_c$ とすると、

$$
H(s)\;=\;\frac{Y(s)}{X(s)}
=\;\frac{\omega_c}{s + \omega_c}.
$$

（通過域ゲインを $1$ に正規化した形です。）

---

**ステップ2**：両辺を分母に掛け合わせ、

$$
Y(s)
= H(s)\,X(s)
\;\Longrightarrow\;
(s + \omega_c)\,Y(s)
= \omega_c\,X(s).
$$

---

**ステップ3**：ラプラス演算子 $s$ は時間微分に対応します。
初期条件 $y(0)=0$ と仮定すると、

$$
\mathcal{L}\{y'(t)\}=s\,Y(s).
$$

したがって

$$
s\,Y(s) + \omega_c\,Y(s) = \omega_c\,X(s)
\quad\Longleftrightarrow\quad
\mathcal{L}\{\,y'(t)\} + \omega_c\,\mathcal{L}\{\,y(t)\}
= \omega_c\,\mathcal{L}\{\,x(t)\}.
$$

---

**ステップ4**：逆ラプラス変換して時刻領域の微分方程式に戻します。

$$
\boxed{
y'(t) + \omega_c\,y(t) = \omega_c\,x(t).
}
$$

これが求める「１次常微分方程式」です。

---

## 2. 微分方程式から離散系差分方程式への導出

ここでは、最も単純かつ安定な「後退差分（Backward‐Euler）法」を用いて離散化します。

---

### 2.1 差分近似

時刻 $t=nT$ における信号を

$$
y[n] = y(nT),\quad x[n]=x(nT)
$$

と書き、微分を「後退差分」で近似します：

$$
y'(t)\bigl|_{t=nT}
\;\approx\;
\frac{y[n] - y[n-1]}{T},
$$

ただし $T$ はサンプリング周期です。

---

### 2.2 微分方程式への代入

先ほど得た

$$
y'(t) + \omega_c\,y(t) = \omega_c\,x(t)
$$

の $y'(t)$ に差分を代入し、すべて $t=nT$ における値に揃えます：

$$
\frac{y[n] - y[n-1]}{T}
\;+\;\omega_c\,y[n]
\;=\;\omega_c\,x[n].
$$

---

### 2.3 両辺を $T$ 倍して整理

まず両辺に $T$ を掛けて分母をなくします：

$$
y[n] - y[n-1]
\;+\;\omega_c\,T\,y[n]
\;=\;\omega_c\,T\,x[n].
$$

次に $y[n]$ と $y[n-1]$ の項をまとめます：

$$
y[n]\bigl(1 + \omega_c\,T\bigr)
\;=\;
y[n-1] + \omega_c\,T\,x[n].
$$

---

### 2.4 差分方程式形への帰着

両辺を $1+\omega_c T$ で割って

```math
y[n]
= \underbrace{\frac{1}{1 + \omega_c T}}_{\displaystyle \alpha}\;y[n-1]
\;+\;\underbrace{\frac{\omega_c T}{1 + \omega_c T}}_{\displaystyle 1-\alpha}\;x[n],
```

ただし

```math
\alpha = \frac{1}{1+\omega_c T},
\qquad
1-\alpha = \frac{\omega_c T}{1+\omega_c T}.
```

---

## 最終差分方程式

```math
\boxed{
y[n]
= \alpha\,y[n-1]
\;+\;(1-\alpha)\,x[n],
\quad
\alpha = \frac{1}{1 + \omega_c\,T}.
}
```

* $\alpha$ は「自己帰還ゲイン」
* $(1-\alpha)$ は「入力へのゲイン」

この式をループで実装すれば、１次バターワース・ローパスフィルタが動作します。

---

### 【まとめ】

1. 伝達関数 $H(s)=\omega_c/(s+\omega_c)$
2. $(s+\omega_c)Y(s)=\omega_c X(s)$ → 時刻領域で $y'(t)+\omega_c y(t)=\omega_c x(t)$
3. 後退差分で $y'(t)\approx (y[n]-y[n-1])/T$ と近似
4. 整理 → $y[n](1+\omega_c T)=y[n-1]+\omega_c T\,x[n]$
5. 最終的に $y[n]=\alpha y[n-1}+(1-\alpha)x[n]$

以上で、**微分方程式から省略なく差分方程式**への導出が完了です。

---

以下、まずは双一次変換（Bilinear Transform）を用いて

$$
s \;\longmapsto\; \frac{2}{T}\,\frac{1 - z^{-1}}{1 + z^{-1}}
$$

を連続時間の1次／2次 Butterworth 伝達関数に代入し、分母・分子を有理化→正規化することで得られる

* **1次**：
```math
\;H(z)=\dfrac{b_0 + b_1 z^{-1}}{1 + a_1 z^{-1}}
```

* **2次**：
```math
\;H(z)=\dfrac{b_0 + b_1 z^{-1} + b_2 z^{-2}}{1 + a_1 z^{-1} + a_2 z^{-2}}
```

の **係数 $b_i,a_i$ の閉形式** を、計算過程を省略せずに示します。

---

## 1. １次 Butterworth

連続時間伝達関数

$$
H(s)=\frac{\omega_c}{\,s + \omega_c\,}.
$$

双一次変換置換

$$
s\to\frac{2}{T}\frac{1-z^{-1}}{1+z^{-1}}.
$$

これを代入すると

$$
H(z)
=\frac{\omega_c}{\displaystyle
 \frac{2}{T}\frac{1-z^{-1}}{1+z^{-1}} + \omega_c
}
=\omega_c\,\frac{1+z^{-1}}{\frac{2}{T}(1-z^{-1}) + \omega_c(1+z^{-1})}.
$$

分母を展開してまとめ、$(1+z^{-1})$ で約分せずに先頭を有理化します：

```math
\begin{aligned}
\text{分母}
&=\frac{2}{T}(1-z^{-1}) + \omega_c(1+z^{-1})
= \frac{2}{T} - \frac{2}{T}z^{-1} + \omega_c + \omega_c z^{-1}\\
&=\Bigl(\omega_c+\tfrac{2}{T}\Bigr)
 - \Bigl(\tfrac{2}{T}-\omega_c\Bigr)z^{-1}.
\end{aligned}
```

よって

$$
H(z)
= \omega_c\;\frac{1+z^{-1}}
      {\Bigl(\omega_c+\tfrac{2}{T}\Bigr)
       -\Bigl(\tfrac{2}{T}-\omega_c\Bigr)z^{-1}}.
$$

分母・分子を同じ定数 $\omega_c+\tfrac{2}{T}$ で割り、「分母先頭を1」に正規化すると

```math
\begin{aligned}
b_0 &= \frac{\omega_c}{\,\omega_c + \tfrac{2}{T}\,},\quad
b_1 = \frac{\omega_c}{\,\omega_c + \tfrac{2}{T}\,},\\
a_1 &= -\,\frac{\tfrac{2}{T}-\omega_c}{\,\omega_c + \tfrac{2}{T}\,}.
\end{aligned}
```

簡潔化のため $c=\omega_c\,T$ と置くと

```math
\boxed{
\begin{aligned}
b_0 &= b_1 = \frac{c}{\,c + 2\,},\\
a_1 &= -\,\frac{2 - c}{\,c + 2\,}.
\end{aligned}
}
```

従って差分方程式は

$$
y[n] = -a_1\,y[n-1] + b_0\,x[n] + b_1\,x[n-1].
$$

---

## 2. ２次 Butterworth

連続時間伝達関数

$$
H(s)=\frac{\omega_c^2}{\,s^2 + \sqrt2\,\omega_c\,s + \omega_c^2\,}.
$$

双一次変換置換

$$
s\to\frac{2}{T}\frac{1-z^{-1}}{1+z^{-1}},
$$

を $s^2,\;s$ に代入し、分母・分子に $(1+z^{-1})^2$ を掛けて有理多項式化すると、

```math
H(z)
=\omega_c^2\;\frac{(1+z^{-1})^2}
    {\displaystyle
     \frac{4}{T^2}(1 -2z^{-1}+z^{-2})
    +\sqrt2\,\omega_c\frac{2}{T}(1 - z^{-2})
    +\omega_c^2(1+2z^{-1}+z^{-2})
    }.
```

分母内を $z^{-k}$ ごとにまとめ、分母先頭を 1 に正規化します。計算の簡略化のため

$$
c = \omega_c T,\qquad
D = 4 + 2\sqrt2\,c + c^2
$$

とおくと、

```math
\boxed{
\begin{aligned}
b_0 &= \frac{c^2}{\,D\,},\quad
b_1 = \frac{2c^2}{\,D\,},\quad
b_2 = \frac{c^2}{\,D\,},\\
a_1 &= -\,\frac{\,2c^2 - 8\,}{\,D\,},\quad
a_2 = \frac{\,c^2 - 2\sqrt2\,c + 4\,}{\,D\,}.
\end{aligned}
}
```

従って差分方程式は

```math
y[n]
= -a_1\,y[n-1] - a_2\,y[n-2]
  + b_0\,x[n] + b_1\,x[n-1] + b_2\,x[n-2].
```

---

これらの閉形式 $b_i,a_i$ を MATLAB の `bilinear` あるいは手計算と突き合わせることで、「双一次変換版離散フィルタ」の係数が正しく得られているか確認できます。

