機能安全規格（ISO 26262やIEC 61508など）に対応したマイコンやSoCでは、ECM（Error Control Module）だけでなく、**ハードウェアおよびソフトウェア双方での安全機能**が複合的に実装されています。以下に代表的な機能をまとめます。

---

## 1. ロックステップコア（Lockstep CPU）

- **概要**  
  - 同一命令列を2つ（あるいは3つ）のCPUコアで並行・同期実行し、リアルタイムで結果を比較。  
  - 演算結果の不一致を検出した場合は故障が生じたと判断し、エラー通知や安全処理（リセット等）を行う。  

- **目的**  
  - CPU内部での演算異常（ALU故障やビット化け）を即座に検出するためのハードウェア冗長化手法。  
  - 自動車のパワートレインや制動制御など、**高ASILレベル（ASIL-Dなど）** で要求されるケースが多い。

---

## 2. メモリ保護機能 (ECC / Parity / MPU)

1. **ECC（Error Correction Code）**  
   - 内蔵Flash/RAMにECCを適用し、**1ビットエラーを訂正・2ビット以上のエラーを検出**できる。  
   - ECMがエラーを検知・訂正し、CPUやソフトウェアへ通知。  
2. **パリティチェック**  
   - RAMやレジスタなどで1ビットのパリティを追加。誤り検出のみ行う簡易手法。  
3. **メモリプロテクションユニット (MPU)**  
   - ソフトウェアが不正アクセスを起こさないよう、**アクセス権**（読み/書き/実行）や**有効アドレス範囲**を設定して保護。  
   - 不正アクセスが発生すると例外を起こして異常を検出・処理する。  

---

## 3. ウォッチドッグタイマ (WDT)

- **概要**  
  - 一定時間内に定期リフレッシュ（クリア）が行われない場合、**タイムアウト** となり**リセット**やエラー通知を出す。  
- **目的**  
  - ソフトウェアのハングアップや無限ループなど、“プログラム暴走”を検出し、自動的にシステムを再起動する。  
  - 「ウィンドウウォッチドッグ」と呼ばれる手法で、**早すぎるクリア** も異常とみなす（過大ループ速度エラー）など、より厳格な監視が可能な製品もある。

---

## 4. BIST（Built-In Self Test）

- **概要**  
  - **起動時**（パワーオンリセット後）や**定期**的に、CPUコアの演算部・内部メモリ・周辺ブロックなどを簡易テストする仕組み。  
  - ハードウェアBISTやソフトウェアライブラリ（セルフテスト）を用いて、演算結果の整合やメモリ書き込み/読み出し異常をチェックする。  
- **目的**  
  - システム起動直後に安全性を担保するための“自己診断”機能。  
  - 規格上、一定のテストカバレッジを満たす必要があるため、BISTを使ってハードウェア故障率を下げる。

---

## 5. クロック・電源電圧監視機能

1. **クロックモニタ (Clock Monitor / PLL Lock Detect)**  
   - 外部/内部オシレータが停止したり、PLLがロックを外れたときに検出する。  
   - 異常なクロック振動はCPU動作を狂わせる要因となるため、検出時はフェイルセーフやリセットをかける。  
2. **電源監視 (Brown-out Detection, Voltage Monitor)**  
   - 供給電圧が許容範囲を下回った場合にリセットや割り込みを発生させる。  
   - 不安定電圧下で動作すると不定動作が起こりやすいので、システムを安全に停止させるための機能。

---

## 6. セーフステートへの移行・フェイルセーフハンドラ

- **概要**  
  - 異常検出時（ECCダブルビットエラー、ロックステップ不一致、WDTタイムアウトなど）、**ソフトウェアやハードウェアが安全状態に移行** するための仕組み。  
  - 安全状態（セーフステート）とは、**出力を停止** したり **安全なデフォルト値** を維持したりする設計で、制御不能・暴走状態を防ぐ。  

- **具体例**  
  - 車載では、危険な動作をさせないために**メインリレーをOFF** にする、あるいは**非常用制御モード**に切り替えるなどのフェイルセーフ処理を行う。

---

## 7. 安全管理コントローラ / 安全ドメイン (Safety Island)

- **概要**  
  - 一部のSoCでは、メインCPUとは独立した**セーフティコア**や**安全管理コントローラ**を搭載し、ECMやWDT、BIST、エラーログなどを一元管理。  
  - 異常発生時にメインCPUやシステムへ迅速かつ確実に通知し、**安全制御** を行う。  

- **目的**  
  - メインCPU自体がハングアップしても、**独立安全コントローラ**が動作していればリセット・通報・安全モード移行を指示できる。  
  - システム全体の信頼度（ASILレベルなど）を高めるために重要。

---

## 8. セルフテストライブラリ (Software Test Library)

- **概要**  
  - メーカー提供またはサードパーティ製のソフトウェアライブラリで、**CPU演算テスト**、**メモリテスト**、**周辺テスト** などを一通り実行するAPIがまとめられている。  
  - 関数を呼び出すと内部でテストパターンを実行し、結果をレジスタなどで判定する仕組み。  

- **目的**  
  - 安全規格で求められるテストを“**開発者が容易に組み込める**”ようにし、**認証取得** も簡素化する。  
  - ハードウェアBISTと組み合わせて、**起動時** と **定期的な自己診断** の両面をカバーする。

---

## 9. 高耐ノイズ設計、パッケージ/レイアウト上の工夫

- **EMC/EMI耐性**  
  - 機能安全用途では、ノイズによる誤動作を防ぐために**パッケージ設計**や**内部配線**に注意が払われている。  
- **チップレベルの冗長性**  
  - パッド短絡検出、I/Oポートの過電流保護など、ハード不良が発生しても破壊を最小限に抑える仕組みが用意されている場合がある。

---

## まとめ

- **機能安全対応マイコン** には、単にECM（Error Control Module）だけでなく、**CPUロックステップ、ECC、WDT、BIST、MPU、電源監視、クロック監視、フェイルセーフ制御** といった様々な安全機能が組み込まれています。  
- これらを総合的に連携させることで、**ソフトエラー・ハード故障を速やかに検知** し、システムを安全側へ移行させることが可能になっています。  
- メーカー製のセルフテストライブラリや安全管理コントローラも併せて活用することで、**ISO 26262/IEC 61508 などの機能安全規格** を満たす設計がしやすくなるのが特徴です。

```
                   [ 電源投入 / リセット ]
                           │
                           ▼
                ┌───────────────┐
                │ BIST / セルフテスト  │  ← 起動時メモリテスト、CPU演算テストなど
                └───────────────┘
                           │ OK?
                           │ ┌─── NO → フェイルセーフ or リセット再試行
                           ▼
                ┌─────────────────┐
                │ 通常動作 (Main) │
                └─────────────────┘
                 │  |    |   |
                 │  |    |   └─[ECC] … メモリアクセス毎に自動チェック
                 │  |    └─────[ロックステップ比較器] … CPU演算結果を常時比較
                 │  └────────────[MPU/保護機能] … 不正アクセスを例外捕捉
                 │
                 ▼ (定期)
         [ソフトが WDTリフレッシュ]
                 │
                 │  ┌────────────────────────────┐
                 │  │(もしハング/暴走すればWDTがタイムアウト)│
                 │  └────────────────────────────┘
                 │
  ┌─ ECCエラー検知 (ダブルビット)  → Error IRQ → エラーハンドラ → リセット or フェイルセーフ
  │
  └─ ロックステップ不一致         → 安全モジュール → リセット or フェイルセーフ

```

```
┌───────────────────────────────────────────────┐
│                [ CPU (Lockstep) ]           │
│  ┌─────────────────────┐   ┌─────────────────────┐
│  │ CORE0 (Main)        │   │ CORE1 (Mirror)      │
│  │ (実行命令は同じ)    │   │ (演算結果を比較)    │
│  └─────────┬───────────┘   └─────────┬───────────┘
│            │  同期実行                │ 同期実行
│            ▼                           ▼
│         ┌───────────────────────────────────────┐
│         │ Lockstep Comparator                  │
│         │  → コア間演算結果に不一致あればエラー通知 │
│         └───────────────────────────────────────┘
└───────────────────────────────────────────────┘
                           │
                           │ 不一致/エラー時
                           ▼
  ┌─────────────────────────────────────────┐
  │         [ ECM (Error Control Module) ] │
  │  - ECCエラー, ロックステップ不一致,  │
  │    バスエラー等を集約管理            │
  │  - エラーログ取得 & CPU/Safetyへ通知 │
  │  - 場合によってはリセット制御        │
  └─────────────────────────────────────────┘
         ▲                   ▲
         │                   │ エラー情報 (割り込み/NMIなど)
         │                   └───────────┐
         │                               │
         │                               │
         ▼                               │
┌───────────────────────────┐            │
│       [ Flash ROM ]       │            │
│    + ECCハードウェア       │            │
│    (SEC-DEDなど)           │            │
│  1ビットなら自動訂正       │            │
│  2ビット以上はエラー検出   │            │
└───────────────────────────┘            │
         ▲                               │
         │ 読み出し                       │
         │ ECCエラー                      │
         ▼                               │
┌───────────────────────────┐            │
│       [ SRAM ]            │            │
│    + ECCハードウェア       │            │
│    (SEC-DEDなど)           │            │
└───────────────────────────┘            │
                                          │
                                          │
                 ┌────────────────────────┴────────────────────────┐
                 │              [ WDT (Watchdog Timer) ]          │
                 │ - ソフトが定期的にリフレッシュしない場合       │
                 │   タイムアウトしてリセット発動                 │
                 │ - ハングアップを自動検出→システム再起動        │
                 └─────────────────────────────────────────────────┘
                                          │
                                          │ リセット信号
                                          ▼
                  ┌───────────────────────────────────────────┐
                  │    [ Safety / System Reset Logic ]       │
                  │  - ECMやWDTからの要求があればシステム     │
                  │    をリセットし初期化                    │
                  │  - 起動後にBISTやエラーログ確認等を実施   │
                  └───────────────────────────────────────────┘

```

```
  ┌───────────────────────────[ External Bus or SoC I/F ]──────────────────────────┐
  │                                                                                 │
  │   (他のECU/Peripherals)                                                        │
  │                                                                                 │
  └───────────────────────────────────────────────────────────────────────────────────┘


                         ┌────────────────────────────────────┐
   ┌─────────────────────┤          [ CPU Subsystem ]        ├─────────────────────┐
   │                     └────────────────────────────────────┘                     │
   │                                (Lockstep構成の例)                              │
   │      ┌───────────────────────────┐        ┌───────────────────────────┐        │
   │      │  CORE0 (Main Execution)   │        │ CORE1 (Lockstep Mirror)   │        │
   │      │-命令フェッチ/実行         │        │-同じ命令を同期実行        │        │
   │      │-レジスタセット, ALU       │        │-演算結果を比較器へ送出     │        │
   │      └─────────────┬─────────────┘        └─────────────┬─────────────┘        │
   │                    │ (同一バスアクセス/命令実行)         │                             │
   │                    ▼                                     ▼                             │
   │      ┌──────────────────────────────────────────────────────────────┐                    │
   │      │       Lockstep Comparator (LSC)                             │                    │
   │      │  ・CORE0/CORE1の演算結果・主要レジスタ更新をリアルタイム比較 │                    │
   │      │  ・不一致の場合は "Lockstep Error" を検出 → 例: NMI信号等     │                    │
   │      └──────────────────────────────────────────────────────────────┘                    │
   │                    │                                                                   │
   │                    │ Lockstep Error発生(不一致)                                        │
   │                    │ → 信号ライン (ls_error)                                          │
   │                    ▼                                                                   │
   │      ┌──────────────────────────────────────────────────────────────┐                    │
   │      │   CPU Internal Bus / AXI/AHB Bridge etc.                    │                    │
   │      └──────────────────────────────────────────────────────────────┘                    │
   │                                    │
   │                                    │ CPU命令/データアクセス
   │                                    │
   │                                    ▼
   └───────────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │  (バス経由でFlash/RAMへアクセス)
                                        ▼

┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                          [ Memory Subsystem ]                                            │
│                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │ [ Flash ROM + ECC Logic ]                                                          │   │
│   │   ┌───────────────────────┐      ┌───────────────────────────────────────────────┐ │   │
│   │   │   Flash Array (Code)  │ ---->│   ECC Decoder/Encoder (SEC-DED etc.)         │ │   │
│   │   └───────────────────────┘      └───────────────────────────────────────────────┘ │   │
│   │      │  1) CPUがコード/定数を読み出す                                               │   │
│   │      │     → ECCロジックがビット誤りチェック                                        │   │
│   │      │  2) 1bit誤り → 自動訂正してデータ返却                                        │   │
│   │      │     2bit以上 → "Uncorrectable Error" フラグ                                 │   │
│   │      └───────────────────────────────────────────────────────────────────────────┘   │
│   │                                                                                       │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                 ▲
│                 │ (同様に、RAMもECC付きの場合の例)
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │ [ SRAM + ECC Logic ]                                                               │   │
│   │   ┌───────────────────────┐      ┌───────────────────────────────────────────────┐ │   │
│   │   │   SRAM Array (Data)   │ ---->│   ECC Decoder/Encoder (SEC-DED etc.)         │ │   │
│   │   └───────────────────────┘      └───────────────────────────────────────────────┘ │   │
│   │      │  1) CPU/DMACなどがデータR/W                                                 │   │
│   │      │     → ECCロジックがビット誤りチェック                                        │   │
│   │      │  2) 1bit誤り → 自動訂正 & ステータス記録                                     │   │
│   │      │     2bit以上 → "Uncorrectable Error" フラグ                                 │   │
│   │      └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                           │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ECCエラー検出時 (Single/Doubleビット)
                                        │
                                 ┌──────▼─────────────────────┐
                                 │ [ ECM (Error Control Module)]│
                                 │   - ECCからのErrフラグ受信   │
                                 │   - Lockstepエラー受信       │
                                 │   - バスエラーなども集約     │
                                 └─────────────┬────────────────┘
                                               │
                  ┌─────────────────────────────┼──────────────────────────────────┐
                  │                             │ Error発生時                    │
                  ▼                             │                                ▼
    ┌────────────────────────┐                  │              ┌─────────────────────────────────┐
    │ [ Interrupt Controller ]<----------------─┘              │ [ Safety / Reset Controller ]  │
    │  - 割り込み/NMI管理                         LockstepErr   │  - ECMやWDTリセット要求を受け   │
    │  - ECMが割り込み要求を出す   ECC(2bitErr)  → intLine   →  │    システムリセット発生         │
    └────────────────────────┘    or other → nmiLine         │  - リセット後の復旧シーケンス     │
                                                          └─────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                      [ WDT (Watchdog Timer) ]                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  - ソフトが規定周期でWDTリフレッシュ (WDT_Clear()等)                               │ │
│  │  - リフレッシュ滞る(ハングアップなど) → タイムアウト → ハードウェアリセット     │ │
│  │  - Window WDTの場合、早すぎるクリアも誤動作として検知                           │ │
│  └───────────────────────────────────────────────────────────────────────────────────────┘ │
│          │                                                                           │
│          │ Timeout発生時                                                             │
│          ▼                                                                           │
│    ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│    │   [ Safety / Reset Controller ]                                              │ │
│    │    - WDTリセット要求を受信                                                   │ │
│    │    - マイコン全体にリセット信号                                              │ │
│    └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────────────┘

```

## 1. SoC (System on a Chip) とは

- **SoC (System on a Chip)** とは、コンピュータシステムを構成する主要な機能（CPUコア、メモリ、各種I/O、周辺回路など）を**1つの半導体チップ上に集約**したものを指します。  
- **マイコン（MCU）** もSoCの一種ですが、一般的には「より多機能・高性能なプロセッサ(マルチコア)と大容量メモリ、各種IP（インターフェース回路やDSPブロックなど）」が統合されたものを**SoC** と呼ぶことが多いです。

### 例

- **携帯電話やスマートフォン** のメインチップ（アプリケーションプロセッサ）：CPU・GPU・ISP(画像処理)・DSP・各種I/O が一枚のチップに集まっている。  
- **産業用・車載用SoC**：メインCPUコア＋セーフティコア＋グラフィックス／AIアクセラレータなど、多数の機能をワンチップ化。

### マイコンとSoCの違い (ざっくり)

- **マイコン (MCU)**: 内蔵フラッシュメモリやRAM、簡易な周辺機能(ADC/UART等)を搭載したシングルコア／デュアルコアのシステム。組込み用途でリアルタイム性を重視。  
- **SoC**: より大規模・高機能で、**Linuxや複数OSを並行動作させる**などのアプリケーション向け。  
  - ただし、近年は**機能安全対応のSoC**も増えており、**マイコン的な安全機能**(ECC, WDT, ロックステップコア等)を内蔵する例があります。

---

## 2. ハンドラ (Handler) とは

- **ハンドラ (handler)** とは、**特定のイベントが発生した際に呼び出される処理ルーチン**（関数、プログラム片）のことを指します。  
- 組込みシステムでよく登場するのは、**割り込みハンドラ (interrupt handler)** や **例外ハンドラ (exception handler)** です。

### 割り込みハンドラ (Interrupt Handler)

- 割り込み(Interrupt)が発生した際に、CPUが**自動的に呼び出す**特別な関数です。  
- たとえば **タイマ割り込み** で定期的にシステム処理を呼び出したり、**UART割り込み** で受信完了を受け取ったりする。

### 例外ハンドラ (Exception Handler)

- CPUが**不正命令** や **不正アクセス**, **ゼロ除算** などに遭遇した場合の**例外処理**を行う関数。  
- 機能安全マイコンでは、**ECCで訂正できないエラー** や **ロックステップ不一致** を検出した際に**NMI (Non-Maskable Interrupt) あるいは例外**を発生させ、**例外ハンドラ**内で異常処理（リセット、ログ取得、フェイルセーフ動作）を行う場合が多いです。

### ハンドラが呼ばれる流れ（例: ECC二重ビットエラー）

1. マイコン内部の **ECCロジック** が「訂正不能エラー(ダブルビットエラー)」を検出。  
2. **ECM (Error Control Module)** や **割り込み制御器** に「エラー割り込み要求」を通知。  
3. CPUは実行中の命令を一時中断し、**割り込みベクタテーブル**などで定義された「エラーハンドラ (例: ECC_Error_Handler)」にジャンプ。  
4. ハンドラ関数内でログ収集やリセット指示を行う。

---

## まとめ

- **SoC (System on a Chip)** : CPUや各種周辺回路、メモリなどを単一チップに統合した大規模集積回路。マイコンより高機能化したものを指すケースが多い。  
- **ハンドラ (Handler)** : 特定イベント（割り込みや例外など）の際に呼ばれるプログラムルーチン。組込み開発では**割り込みハンドラ、例外ハンドラ**が代表例。

以上が、SoCとハンドラの基本的な説明になります。
